name: Performance Test

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      payload:
        required: false
        type: string

defaults:
  run:
    shell: bash

jobs:
  get-dependency-details:
    uses: "./.github/workflows/get-dependency-details.yml"
    secrets: inherit
    with:
      owner: "howsoai"
      repo: "amalgam"
      payload: "${{ inputs.payload }}"
        
  performance-test-linux-amd64:
    needs: ['get-dependency-details']
    runs-on: ubuntu-latest
    steps:

    - name: Collect Workflow Telemetry
      uses: catchpoint/workflow-telemetry-action@v2
      with:
        comment_on_pr: off
        proc_trace_chart_show: off
        proc_trace_table_show: off

    - uses: actions/checkout@v4

    - name: Download Amalgam
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh ${{ needs.get-dependency-details.outputs.run-type }} download -D target -R "howsoai/amalgam" -p "*linux-amd64*" "${{ needs.get-dependency-details.outputs.run-id }}"
        # Needed because release/non-release downloads are different structure
        cd target && if [ ! -f *.tar.gz ]; then mv */*.tar.gz ./; fi && tar -xvzf *.tar.gz

    - name: Test
      run: |
        sudo locale-gen es_ES.UTF-8
        ./build.sh performance_test ${{ inputs.version }}
