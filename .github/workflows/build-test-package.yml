name: Reusable WF - Build

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      payload:
        required: false
        type: string

defaults:
  run:
    shell: bash

jobs:

  get-dependency-details:
    uses: "./.github/workflows/get-dependency-details.yml"
    secrets: inherit
    with:
      owner: "howsoai"
      repo: "amalgam"
      payload: "${{ inputs.payload }}"

  build:
    needs: ['get-dependency-details']
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v3

    - name: Download Amalgam
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh ${{ needs.get-dependency-details.outputs.run-type }} download -D target -R "howsoai/amalgam" -p "*linux-amd64*" "${{ needs.get-dependency-details.outputs.run-id }}"
        # Needed because release/non-release downloads are different structure
        cd target && if [ ! -f *.tar.gz ]; then mv */*.tar.gz ./; fi && tar -xvzf *.tar.gz

    - name: Build
      run: |
        ./build.sh build_package ${{ inputs.version }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: howso-engine-${{ inputs.version }}
        path: target/howso-engine-${{ inputs.version }}.tar.gz
        if-no-files-found: error

  test-linux-amd64:
    needs: ['get-dependency-details', 'build']
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Download Amalgam
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh ${{ needs.get-dependency-details.outputs.run-type }} download -D target -R "howsoai/amalgam" -p "*linux-amd64*" "${{ needs.get-dependency-details.outputs.run-id }}"
        # Needed because release/non-release downloads are different structure
        cd target && if [ ! -f *.tar.gz ]; then mv */*.tar.gz ./; fi && tar -xvzf *.tar.gz

    - name: Amalgam version
      run: |
        ${{ github.workspace }}/target/bin/amalgam-mt --version

    - name: Test
      run: |
        sudo locale-gen es_ES.utf8
        ./build.sh test ${{ inputs.version }}

  test-macos-amd64:
    needs: ['get-dependency-details', 'build']
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3

    - name: Download Amalgam
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh ${{ needs.get-dependency-details.outputs.run-type }} download -D target -R "howsoai/amalgam" -p "*darwin-amd64*" "${{ needs.get-dependency-details.outputs.run-id }}"
        # Needed because release/non-release downloads are different structure
        cd target && if [ ! -f *.tar.gz ]; then mv */*.tar.gz ./; fi && tar -xvzf *.tar.gz

    # GitHub macos runner does not support AVX
    - name: Amalgam version
      run: |
        ${{ github.workspace }}/target/bin/amalgam-mt-noavx --version

    - name: Test
      run: |
        ./build.sh test ${{ inputs.version }}

  test-windows-amd64:
    needs: ['get-dependency-details', 'build']
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3

    - name: Download Amalgam
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh ${{ needs.get-dependency-details.outputs.run-type }} download -D target -R "howsoai/amalgam" -p "*windows-amd64*" "${{ needs.get-dependency-details.outputs.run-id }}"
        # Needed because release/non-release downloads are different structure
        cd target && if [ ! -f *.tar.gz ]; then mv */*.tar.gz ./; fi && tar -xvzf *.tar.gz

    - name: Download tz data
      shell: pwsh
      run: |
        ./build/powershell/Download-Tzdata.ps1

    - name: Amalgam version
      run: |
        "${{ github.workspace }}/target/bin/amalgam-mt.exe" --version

    - name: Test
      run: |
        ./build.sh test ${{ inputs.version }}
