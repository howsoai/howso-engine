(seq
	#unit_test (direct_assign_to_entities (assoc unit_test (load "unit_test.amlg")))
	(call (load "unit_test_howso.amlg") (assoc name "ut_h_migration.amlg"))

	;restore 'saved' trainee from original so that it can be operated on
	(if (= (system "os") "Windows")
		(system "system" "copy /Y  unit_test_data\\saved_derived*json ..\\migrations\\")

		(system "system" "cp  unit_test_data/saved_derived*json ../migrations/")
	)

	;grab old exported files
	(declare (assoc
		result (null)
		import_metadata_map (load "unit_test_data/saved_derived.meta.json")
		import_cases_and_sessions_map (load "unit_test_data/saved_derived.exp.json")
	))

	(print "Old exported json: ")
	(call assert_true (assoc
		obs (and (!= (null) import_metadata_map) (!= (null) import_cases_and_sessions_map))
	))

	(print "Old Export version should be 100.0.3 : ")
	(call assert_same (assoc
		exp [100 0 3]
		obs
			(list
				(get import_metadata_map "major_version")
				(get import_metadata_map "minor_version")
				(get import_metadata_map "point_version")
			)
	))

	(call_entity "howso" "upgrade_trainee" (assoc
		trainee "saved_derived"
		root_filepath "../"
		trainee_json_filepath "../migrations/"
	))

	(store "unit_test_data/saved_derived.amlg" (flatten_entity "howso" .false) )
	(assign (assoc t (call (load "unit_test_data/saved_derived.amlg")) ))
	(move_entities t "saved_derived")

	(print "Verify upgraded version is 0.0.0 : ")
	(call assert_same (assoc
		exp (list 0 0 0)
		obs (call_entity "saved_derived" "debug_label" (assoc label (list "major_version" "minor_version" "point_version") ))
	))

	(print "Verify feature limits are correct: ")
	(call assert_same (assoc
		obs
			(get
				(call_entity "saved_derived" "debug_label" (assoc label "!defaultHyperparameters"))
				[ "featureDomainAttributes"]
			)
		exp
			{
				".date_delta_1" 6390672.105262753
				".date_lag_1" 3099772800
				".f1_delta_1" (null)
				".f1_lag_1" 8082.998390652197
				".f1_rate_1" 0.0020075821526378134
				".f2_delta_1" (null)
				".f2_delta_2" (null)
				".f2_lag_1" 8082.998390652197
				".f2_rate_1" 0.0020523502773464853
				".f2_rate_2" 9.672031586687185e-10
				".f3_delta_1" (null)
				".f3_lag_1" 8082.998390652197
				".f3_rate_1" 0.0017778264374736727
				".reverse_series_index" (null)
				".series_index" (null)
				".series_progress" (null)
				".series_progress_delta" 1
				".synchronous_counter" (null)
				".synchronous_counter_lag_1" (null)
				".time_to_horizon" (null)
				ID (null)
				date 3099772800
				f1 8082.998390652197
				f2 8082.998390652197
				f3 8082.998390652197
			}
	))

	(call exit_if_failures (assoc msg "Migration version script." ))

	;Sanity check that some cached values are persisted:
	(print "Persisted !cachedFeatureMinResidualMap: ")
	(call assert_same (assoc
		obs (call_entity "saved_derived" "debug_label" (assoc label "!cachedFeatureMinResidualMap"))
		exp
			{
				".date_delta_1" 18.164616840113528
				".date_lag_1" 508.6092715231788
				".f1_lag_1" 2.102386207818731e-08
				".f1_rate_1" 4.451975965806267e-24
				".f2_lag_1" 4.2047724165337634e-08
				".f2_rate_1" 1.1129939914515667e-24
				".f2_rate_2" 5.535642484489544e-23
				".f3_lag_1" 2.102386207818731e-08
				".f3_rate_1" 2.136948463587008e-24
				".series_progress" 1.6823896494341489e-06
				".series_progress_delta" 2.5601581621824196e-08
				ID 0.00021021652301870928
				date 508.6092715231788
				f1 2.102386207818731e-08
				f2 4.2047724165337634e-08
				f3 2.102386207818731e-08
			}

	))

	(print "Persisted !featureCustomDerivedMethods correctly: ")
	(call assert_same (assoc
		obs (get (call_entity "saved_derived" "debug_label" (assoc label "!featureCustomDerivedMethods")) (list "f1" "react"))
		exp
			(lambda
				(+
					(if (and (= 0 0) (contains_index feature_values_map ".f1_lag_1") )
						(get feature_values_map ".f1_lag_1")
					)
					(*
						(if (and (= 0 0) (contains_index feature_values_map ".date_delta_1") )
							(get feature_values_map ".date_delta_1")
						)
						(if (and (= 0 0) (contains_index feature_values_map ".f1_rate_1") )
							(get feature_values_map ".f1_rate_1")
						)
					)
				)
			)
	))

	(print "Persisted !featureCustomDerivedMethods correctly: ")
	(call assert_same (assoc
		obs (get (call_entity "saved_derived" "debug_label" (assoc label "!featureCustomDerivedMethods")) (list ".date_lag_1" "train"))
		exp
			(lambda
				(if (and (>= (- series_row_index 1) 0) (contains_index feat_index_map "date"))
					(get series_data (list (- series_row_index 1) (get feat_index_map "date")) )
				)
			)
	))

	(call exit_if_failures (assoc msg "Persisted model metadata." ))


	(print "Persisted cases correctly: ")
	(call assert_same (assoc
		obs (get (call_entity "saved_derived" "get_num_training_cases") (list 1 "payload" "count"))
		exp 4756
	))


	;pull data for case index 14
	(assign (assoc
		result
			(call_entity "saved_derived" "get_cases" (assoc
				case_indices (list (list "session" 14))
			))
	))
	(call keep_result_payload)

	(print "Persisted particular case data correctly: ")
	(call assert_same (assoc
		obs (zip (get result "features") (get result (list "cases" 0)))
		exp
			{
				".date_delta_1" 2678400
				".date_lag_1" "2011-02-28"
				".f1_delta_1" 0.6499999999999773
				".f1_lag_1" 307.11
				".f1_rate_1" 2.426821983273511e-07
				".f2_delta_1" -2.4500000000000455
				".f2_delta_2" -12.640000000000043
				".f2_lag_1" 311.23
				".f2_rate_1" -9.147252090800648e-07
				".f2_rate_2" -1.9141507812374208e-12
				".f3_delta_1" -5.760000000000048
				".f3_lag_1" 297.16
				".f3_rate_1" -2.15053763440862e-06
				".reverse_series_index" 101
				".series_index" 14
				".synchronous_counter" 0
				".synchronous_counter_lag_1" 0
				".time_to_horizon" 0
				ID 31855
				date "2011-03-31"
				f1 307.76
				f2 308.78
				f3 291.4
			}
	))

	(call exit_if_failures (assoc msg "Persisted cases." ))

	(print "Updated sessions to add total_instance_count: ")
	(call assert_same (assoc
		obs (retrieve_from_entity ["howso" "session"] ".total_instance_count")
		exp 4756
	))
	(call exit_if_failures (assoc msg "Updated session labels." ))

	;verify exporting post-api removal versions:
	(assign_to_entities "howso" (assoc major_version 919))

	(assign (assoc
		result
			(call_entity "howso" "export_trainee" (assoc
				trainee "saved_derived_bad"
				trainee_filepath "bad_folder/"
				root_filepath "../"
			))
	))
	(call keep_result_errors)
	(print "Export fails with bad filepath: ")
	(call assert_same (assoc
		exp "Failed to export trainee metadata."
		obs result
	))

	(call_entity "howso" "export_trainee" (assoc
		trainee "saved_derived_new"
		root_filepath "../"
	))

	(assign (assoc
		import_metadata_map (load "../migrations/saved_derived_new.meta.json")
		import_cases_and_sessions_map (load "../migrations/saved_derived_new.exp.json")
	))

	(print "Exported json: ")
	(call assert_true (assoc
		obs (and (!= (null) import_metadata_map) (!= (null) import_cases_and_sessions_map))
	))

	(print "Export version should be 919.0.0 : ")
	(call assert_same (assoc
		exp (list 919 0 0)
		obs
			(list
				(get import_metadata_map "major_version")
				(get import_metadata_map "minor_version")
				(get import_metadata_map "point_version")
			)
	))

	(call exit_if_failures (assoc msg "Exporting JSON." ))

	(call_entity "howso" "upgrade_trainee" (assoc
		trainee "saved_derived_new"
		root_filepath "../"
		trainee_json_filepath "../migrations/"
	))

	(print "Persisted new !hyperparameterMetadataMap: ")
	(declare (assoc
		updated_hp_map (call_entity "howso" "debug_label" (assoc label "!hyperparameterMetadataMap"))
		ctx_key ".date_delta_1..date_lag_1..f1_lag_1..f1_rate_1..f2_lag_1..f2_rate_1..f2_rate_2..f3_lag_1..f3_rate_1..series_progress..series_progress_delta.ID.date.f1.f2.f3."
	))
	(call assert_true (assoc
		obs
			(and
				(contains_index (get updated_hp_map "targetless") ctx_key)
				;all the deltas, lags, rates, series_progress features
				(= 16 (size (get updated_hp_map ["targetless" ctx_key ".none" "featureMdaMap"])))
			)
	))

	(print "definedFeatures is updated and correct: ")
	(call assert_same (assoc
		obs (call_entity "howso" "debug_label" (assoc label "!definedFeatures"))
		exp
			[
				".case_edit_history"
				".case_weight"
				".date_delta_1"
				".date_lag_1"
				".f1_delta_1"
				".f1_lag_1"
				".f1_rate_1"
				".f2_delta_1"
				".f2_delta_2"
				".f2_lag_1"
				".f2_rate_1"
				".f2_rate_2"
				".f3_delta_1"
				".f3_lag_1"
				".f3_rate_1"
				".imputed"
				".influence_weight_entropy"
				".probability_mass"
				".reverse_series_index"
				".series_index"
				".session"
				".session_training_index"
				".synchronous_counter"
				".synchronous_counter_lag_1"
				".time_to_horizon"
				"ID"
				"date"
				"f1"
				"f2"
				"f3"
			]
		unordered .true
	))

	 ;cleanup saved test dataset
	(declare (assoc
		remove "del "
		slash "\\"
	))
	(if (!= (system "os") "Windows")
		(assign (assoc remove "rm " slash "/"))
	)

	(system "system" (concat remove "unit_test_data" slash "saved_derived.amlg") )
	(system "system" (concat remove ".." slash "migrations" slash "saved_derived*json") )

	(call exit_if_failures (assoc msg "Migration of a json trainee."))


	;test with caml file
	(destroy_entities "howso")
	(call (load "unit_test_howso.amlg") (assoc name "ut_h_migration.amlg" skip_init .true) )


	;set !file_extension to caml to load old caml
	(accum_entity_roots "howso" (list
		(set_labels
			(lambda (assign_to_entities (assoc !file_extension "caml")))
			["amlg_to_caml"]
		)
	))
	(call_entity "howso" "amlg_to_caml")

	(print "Expecting a warning from the Amalgam binary on the console (old caml version 71.1.0): ")
	(assign (assoc
		result
			(call_entity "howso" "upgrade_trainee" (assoc
				trainee "ts_trainee"
				root_filepath "../"
				trainee_amlg_filepath "./unit_tests/unit_test_data/"
			))
	))

	(print "Upgraded caml file: ")
	(call assert_true (assoc
		obs (= 1 (first result))
	))

	(assign (assoc
		result (call_entity "howso" "get_num_training_cases")
	))
	(call keep_result_payload)
	(print "Training cases are there: ")
	(call assert_same (assoc
		obs (get result "count")
		exp 4756
	))

	(print "Time Series cached values are correct: ")
	(call assert_same (assoc
		obs (call_entity "howso" "debug_label" (assoc label "!tsFeaturesMap"))
		exp
			{
				covariate_features []
				delta_features [".date_delta_1" ".f3_delta_1" ".f2_delta_1" ".f2_delta_2" ".f1_delta_1"]
				derived_order_features []
				derived_stationary_features []
				lag_features [".date_lag_1" ".f3_lag_1" ".f2_lag_1" ".f1_lag_1"]
				minimum_time_bound 1264896000
				rate_features [".f3_rate_1" ".f2_rate_1" ".f2_rate_2" ".f1_rate_1"]
				series_id_features ["ID"]
				ts_derived_features [
						".series_index"
						".reverse_series_index"
						".date_lag_1"
						".f3_lag_1"
						".f2_lag_1"
						".f1_lag_1"
						".date_delta_1"
						".f3_delta_1"
						".f2_delta_1"
						".f2_delta_2"
						".f1_delta_1"
						".f3_rate_1"
						".f2_rate_1"
						".f2_rate_2"
						".f1_rate_1"
					]
			}
	))

	(call exit_if_failures (assoc msg "Migration of a caml trainee." ))

	(call exit_if_failures (assoc msg unit_test_name ))

)


