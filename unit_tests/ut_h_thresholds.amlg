(seq
	#unit_test (direct_assign_to_entities (assoc unit_test (load "unit_test.amlg")))
	(call (load "unit_test_howso.amlg") (assoc name "ut_h_thresholds.amlg"))

	(call_entity "howso" "create_trainee" (assoc trainee "st_model2" ))

	(call_entity "howso" "set_internal_parameters" (assoc
		trainee "st_model2"
		default_hyperparameter_map (assoc "k" 1 "p" 2 "dt" -1)
	))
	(call_entity "howso" "set_min_ablatement_model_size" (assoc trainee "st_model2" min_ablatement_model_size 1))

	(call_entity "howso" "train" (assoc
		trainee "st_model2"
		features (list "label1" "label2" "action")
		input_cases (list (list 1 2 1) (list 1 2 1) (list -4 456 34534) (list -4 456 34534) )
	))


;VERIFY HIGHER CONVICTION OF ADDING SAME CASE
	(assign (assoc
		conviction
			(call_entity "howso" "batch_react_group" (assoc
				trainee "st_model2"
				features (list "label1" "label2" "action")
				new_cases (list (list (list -4 456 34534)))
			))
	))

	(print "Computed conviction of new case with same values: " )
	(call assert_approximate (assoc obs (get conviction (list "payload" "familiarity_conviction_addition" 0)) exp 2.19356 percent 0.01))

	(call exit_if_failures (assoc msg "Expected higher conviction of 'same' new case"))


;VERIFY REMOVE CASE
	(call_entity "howso" "move_cases" (assoc
		trainee "st_model2"
		num_cases 1
		condition (assoc "label1" -4 "label2" 456 "action" 34534)
	))
	(assign (assoc result (call_entity "howso" "get_num_training_cases" (assoc trainee "st_model2"))))
	(print "Removal of previous case: ")
	(call assert_same (assoc exp 3 obs (get result (list "payload" "count"))))

	(call exit_if_failures (assoc msg "Removed a case"))

;VERIFY CONVICTION OF NEW CASE WITH WEIGHTS
	(declare (assoc
		int_params
			(get
				(call_entity "howso" "get_internal_parameters" (assoc trainee "st_model2"))
				(list "payload" "default_hyperparameter_map")
			)
	))

	;set weights
	(accum (assoc
		int_params
			(assoc
				"featureWeights" (assoc
					"label1" 10
					"label2" .02
					"action" .00000003
				)
			)
	))

	(call_entity "howso" "set_internal_parameters" (assoc
		trainee "st_model2"
		default_hyperparameter_map int_params
	))

	(assign (assoc
		conviction
			(call_entity "howso" "batch_react_group" (assoc
				trainee "st_model2"
				features (list "label1" "label2" "action")
				new_cases (list (list (list -4 456 34534)))
			))
	))

	(print "Updated conviction of the adding the same case again: ")
	(call assert_approximate (assoc obs (get conviction (list "payload" "familiarity_conviction_addition" 0))exp 1.28219 percent 0.01))

	(call exit_if_failures (assoc msg "Updated new case conviction with weights"))

	(call exit_if_failures (assoc msg unit_test_name))
)