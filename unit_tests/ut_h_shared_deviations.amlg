(seq
	#unit_test (direct_assign_to_entities (assoc unit_test (load "unit_test.amlg")))
	(call (load "unit_test_howso.amlg") (assoc name "ut_h_shared_deviations.amlg" retries 1))

	(call_entity "howso" "set_feature_attributes" (assoc
		feature_attributes
			(assoc
				"size" (assoc "type" "nominal")
				"fruit" (assoc "type" "nominal")
				"color1" (assoc "type" "nominal" "unique" (true))
				"color2" (assoc "type" "nominal" "unique" (true))
				"color3" (assoc "type" "nominal" "unique" (true))
			)
	))

	; h,
	(declare
		(assoc
			result (null)
			features (list "height" "width" "length" "tart" "sweet" "size" "weight" "fruit" "color1" "color2" "color3")
			action_features (list  "fruit")
			context_features (list "height" "width" "length" "tart" "sweet" "size" "weight"  "color1" "color2" "color3")
			fruit_data
				(list
					;		"h" "w" "l" 	"tart" "sweet" "size" 	"weight" 	"fruit" "     "color1"     "color2"     "color3"
					(list 	1 	0	1 		1		1		"small" 	1 		"strawberry"  "red-1"      "red-1"      "red-1")
					(list 	2   2 	2		2   	.45 	"small" 	.8 		"strawberry"  "red-2"      "red-2"      "red-2")
					(list 	3	4 	3 		3 		.42 	"small" 	1.2 	"strawberry"  "red-3"      "red-3"      "red-3")
					(list 	4	6 	4 		4		.49 	"small" 	1.1 	"strawberry"  "red-4"      "red-4"      "red-4")

					(list 	5	8	5		5 		.4		"small" 	2 		(null)        "green-1"    "green-1"    "green-1")
					(list 	6   10  6		6		.55 	"medium" 	3 		"apple"       "green-2"    "green-2"    "green-2")
					(list 	7   12	7		7		.52 	"medium" 	3.5 	"apple"       "green-3"    "green-3"    "green-3")
					(list 	8   14	8   	8   	.54 	"medium" 	4.5 	(null)        "green-4"    "green-4"    "green-4")

					(list 	9   16	9		9		.60		"small" 	(null) 	"banana"      "yellow-1"   "yellow-1"   "yellow-1")
					(list 	10  18	10  	10		.65 	"medium" 	(null)	"banana"      "yellow-2"   "yellow-2"   "yellow-2")
					(list 	11	20	11  	11		.69 	"medium" 	5.5	 	"banana"      "yellow-3"   "yellow-3"   "yellow-3")
					(list 	12	22	12 		12		.62 	"medium" 	7 		"banana"      "yellow-4"   "yellow-4"   "yellow-4")
				)
		)
	)


	(call_entity "howso" "train" (assoc
		features features
		cases fruit_data
		session "unit_test"
	))

	(call_entity "howso" "analyze" (assoc
		context_features features
		action_features (list (last features))
		shared_deviations_features (list (list "weight" "tart") (list "l" "sweet")  (list "fruit" "color1") (list "color2" "color3"))
	))
	; color3 should have the same residuals as fruit, but color 2 and 3 should be null


	(print "single target doesn't modify default: ")
	(call assert_same (assoc
		obs defaults
		exp
			(assoc
				"paramPath" (list ".default")
				"featureDomainAttributes" (assoc "fruit" (null) "size" (null))
				"featureWeights" (null)
				"p" 0.1
				"dt" -1
				"k" 8
				"featureDeviations" (null)
				"allFeatureResidualsCached" (false)
			)

	))

	(print "single target has expected attributes: ")
	(call assert_true (assoc
		obs
			(and
				(!= (null) (get hp_map (list "fruit" "height.length.size.sweet.tart.weight.width." "full" ".none" "k")))
				(!= (null) (get hp_map (list "fruit" "height.length.size.sweet.tart.weight.width." "full" ".none" "p")))
				(!= (null) (get hp_map (list "fruit" "height.length.size.sweet.tart.weight.width." "full" ".none" "dt")))
				(> (size (get hp_map (list "fruit" "height.length.size.sweet.tart.weight.width." "full" ".none" "featureWeights"))) 0)
			)
	))

	(call exit_if_failures (assoc msg unit_test_name ))
)
