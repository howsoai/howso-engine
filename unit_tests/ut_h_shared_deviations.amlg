(seq
	#unit_test (direct_assign_to_entities (assoc unit_test (load "unit_test.amlg")))
	(call (load "unit_test_howso.amlg") (assoc name "ut_h_shared_deviations.amlg" retries 1))

	(call_entity "howso" "set_feature_attributes" (assoc
		feature_attributes
			(assoc
				"size" (assoc "type" "nominal")
				"fruit" (assoc "type" "nominal")
				"color1" (assoc "type" "nominal" "unique" (true))
				"color2" (assoc "type" "nominal" "unique" (true))
				"color3" (assoc "type" "nominal" "unique" (true))
			)
	))

	; h,
	(declare
		(assoc
			result (null)
			features (list "height" "width" "length" "tart" "sweet" "size" "weight" "fruit" "color1" "color2" "color3")
			action_features (list  "fruit")
			context_features (list "height" "weight" "length" "tart" "sweet" "size" "weight"  "color1" "color2" "color3")
			fruit_data
				(list
					;		"h" "w" "l" 	"tart" "sweet" "size" 	"weight" 	"fruit" "     "color1"     "color2"     "color3"
					(list 	1 	0	1 		1		1		(null) 	    1 		"strawberry"  "red-1"      "red-1"      "red-1")
					(list 	2   2 	2		2   	.45 	"small" 	.8 		"strawberry"  "red-2"      "red-2"      "red-2")
					(list 	3	4 	3 		3 		.42 	"small" 	1.2 	"strawberry"  "red-3"      "red-3"      "red-3")
					(list 	4	6 	4 		4		.49 	"small" 	1.1 	"strawberry"  "red-4"      "red-4"      "red-4")

					(list 	5	8	5		5 		.4		"small" 	2 		(null)        "green-1"    "green-1"    "green-1")
					(list 	6   10  6		6		.55 	"medium" 	3 		"apple"       "green-2"    "green-2"    "green-2")
					(list 	7   12	7		7		.52 	"medium" 	3.5 	"apple"       "green-3"    "green-3"    "green-3")
					(list 	8   14	8   	8   	.54 	"medium" 	4.5 	(null)        "green-4"    "green-4"    "green-4")

					(list 	9   16	9		9		.60		"small" 	(null) 	"banana"      "yellow-1"   "yellow-1"   "yellow-1")
					(list 	10  18	10  	10		.65 	"medium" 	(null)	"banana"      "yellow-2"   "yellow-2"   "yellow-2")
					(list 	11	20	11  	11		.69 	(null) 	    5.5	 	"banana"      "yellow-3"   "yellow-3"   "yellow-3")
					(list 	12	22	12 		12		.62 	"medium" 	7 		"banana"      "yellow-4"   "yellow-4"   "yellow-4")
				)
		)
	)


	(call_entity "howso" "train" (assoc
		features features
		cases fruit_data
		session "unit_test"
	))

	; (assign (assoc
	; 	result
	; 		(call_entity "howso" "analyze" (assoc
	; 			context_features features
	; 			action_features (list (last features))
	; 			shared_deviations_features (list (list "length" "height") (list "length" "sweet")  (list "fruit" "color1"))
	; 		))
	; ))
	; (call keep_result_errors)


	(call_entity "howso" "analyze" (assoc
		context_features features
		action_features (list (last features)) ; should be height, fruit
		shared_deviations_features (list (list "weight" "height") (list "length" "sweet") (list "size" "fruit"))
	))

	(print "single target doesn't modify default: ")
	(call assert_same (assoc
		obs result
		exp	(list
			"Features can only share deviations with one group, the following features are appear in more than one shared deviations groups: l." "Features with shared deviations may not be unique nominals, as they have null deviations. The following features are in a shared deviations group and is a unique nominal: color1."
		)
	))
	; color3 should have the same residuals as fruit, but color 2 and 3 should be null

	(call_entity "howso" "analyze" (assoc
		context_features features
		action_features (list (last features))
		shared_deviations_features (list (list "h" "w") (list "l" "tart") )
	))

	(call exit_if_failures (assoc msg unit_test_name ))
)
