(seq
	#unit_test (direct_assign_to_entities (assoc unit_test (load "unit_test.amlg")))
	(call (load "unit_test_howso.amlg") (assoc name "ut_h_value_contributions.amlg"))

	(call_entity "howso" "create_trainee" (assoc trainee "model"))

	(declare (assoc
		model_data (load "unit_test_data/student_tests.csv")
	))
	(declare (assoc
		data (tail model_data)
		features (first model_data)
	))

	(call_entity "howso" "set_feature_attributes" (assoc
		feature_attributes
			(assoc
				"name" (assoc "type" "nominal" "data_type" "string")
				"subject" (assoc "type" "nominal" "data_type" "string")
				"is_multiple_choice" (assoc "type" "nominal" "data_type" "string")
				"num_questions" (assoc "type" "continuous")
				"minutes" (assoc "type" "continuous")
				"study_time" (assoc "type" "continuous")
				"score" (assoc "type" "continuous")
			)
	))

	(call_entity "howso" "train" (assoc
		cases data
		features features
		session "session1"
	))

	(call_entity "howso" "analyze" (assoc convergence_threshold 0 ))

	 (print "Robust Accuracy Contributions:"
	 	(get
			(call_entity "howso" "react_aggregate" (assoc
				details { "feature_robust_accuracy_contributions" .true }
				action_features [ "score"]
				convergence_threshold 0
				num_robust_accuracy_contributions_samples 100000
			))
			[1 "payload"]
		)
	 )
	 (print "ANALYSIS:\n 'name', 'study_time' and 'subject' predict 'scores' the best  (study_time is highly correlatedb/c it's derived from score and minutes)\n")

	 (print "\nValue Robust Accuracy Contributions\n---\n")
	 (print "Computing for 'subject': ")
	 (print
	 	(get
			(call_entity "howso" "react_aggregate" (assoc
				details { "value_robust_accuracy_contributions" .true}
				value_robust_ac_action_feature "score"
				value_robust_ac_focus_features [ "subject" ]
			))
			[1 "payload" "value_robust_accuracy_contributions"]
		)
	 )
	(print
		"ANALYSIS:\nNote: if you average the individual ac_values for an individual feature, they match the feature ac values.\n"
		"	everyone gets similar very high grades in 'art'\n"
		"	everyone does consistently well in 'math', even the poor performers\n\n"
	)

	(print "Computing for 'name': ")
	(print
		(get
			(call_entity "howso" "react_aggregate" (assoc
				details { "value_robust_accuracy_contributions" .true}
				value_robust_ac_action_feature "score"
				value_robust_ac_focus_features [ "name" ]
			))
			[1 "payload" "value_robust_accuracy_contributions"]
		)
	)
	(print
		"ANALYSIS:\n"
		"	'anne' gets perfect 'math' scores and does well overall\n"
		"	'bill' is consistently in the 90s across the board\n"
		"	'david' is consistently in the 80s across the board\n"
		"	'cora's scores vary widely\n\n"
	)

	 (print "Computing for 'name' and 'subject': ")
	 (print
	 	(get
			(call_entity "howso" "react_aggregate" (assoc
				details { "value_robust_accuracy_contributions" .true}
				value_robust_ac_action_feature "score"
				value_robust_ac_focus_features [ "name" "subject" ]
			))
			[1 "payload" "value_robust_accuracy_contributions"]
		)
	)
	(print
		"ANALYSIS:\ncombination 'name' and 'subject':\n"
		"	'anne' gets perfect 'math' (and almost perfect 'history') scores\n"
		"	'fiona' is a poor student, but does consistently bad at 'science'\n"
		"	'ed's scores vary, but are usually consistent within each subject\n\n"
	)

	(print "Computing for 'name' and 'study_time': ")
	(print
	 	(get
			(call_entity "howso" "react_aggregate" (assoc
				details { "value_robust_accuracy_contributions" .true}
				value_robust_ac_action_feature "score"
				value_robust_ac_focus_features [ "name" "study_time" ]
			))
			[1 "payload" "value_robust_accuracy_contributions"]
		)
	)
	(print
		"ANALYSIS:\ncombination 'name' and 'study_time':\n"
		"	high study time for 'anne' gets consistently excellent scores\n"
		"	low study time for 'fiona' is consistently low scores, etc.\n\n"
	)

	(call exit_if_failures (assoc msg unit_test_name))
)